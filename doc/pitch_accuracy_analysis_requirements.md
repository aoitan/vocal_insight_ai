# 音程判定機能 要件定義書

## 1. 背景と目的
- ユーザー歌唱の音程精度を可視化することで、フィードバックの質を高め、学習効果を向上させる。
- 既存の音響分析パイプラインに新たな特徴量モジュールとして音程判定を追加し、コアライブラリ、CLI、API、UI から再利用できるようにする。
- リファレンス音声（抽出済みボーカル）を利用した相対評価を実現し、将来的には歌唱表現の対照分析へ拡張する基盤を整備する。

## 2. 対象範囲
- ユーザー音声とリファレンス音声を入力として音程精度を評価するアルゴリズム。
- 音程判定結果のJSON出力と、分析用プロンプトへの情報付加を制御する設定。
- コアライブラリ/CLI/API/UI による音程判定機能の呼び出しと再利用。
- 将来の表現比較指標を格納できる柔軟なデータ構造の定義。

## 3. 機能要件
- ユーザー音声とリファレンス音声（`numpy.ndarray` + サンプリングレート、またはファイルパス）を入力に取り、音程精度を示す指標を算出する。
  - 例: 平均ピッチ偏差（セント）、音程一致率、遅延時間補正後のダイナミックタイムワーピング距離など。
- リファレンス音声が未指定の場合はユーザー音声単体を解析し、「音程判定なし」として処理結果を返す。
- 設定値に応じて、音程判定結果を分析プロンプトに組み込む/組み込まないを切り替えられること。
- 音程判定結果は JSON 形式で保存・返却し、既存の分析出力と統合できるよう構造化する。
- 同一の音程判定モジュールを CLI/API/UI から呼び出せる共通インターフェースを提供する。
- リファレンス音声の前処理（サンプリングレート統一、必要に応じたタイミング揃え）を自動化し、既存の音響前処理モジュールと統合する。

## 4. 非機能要件
- 5分以内の音源ペアに対してCPU単体でリアルタイム近似（実時間の2倍以内）で処理可能な性能を目標とする。
- ピッチトラッキングの誤検出を抑えるため、設定可能なスムージング/外れ値除外処理を提供する。
- 数値結果の再現性を確保するため、同条件で実行すれば同一結果が得られる determinism を担保する。
- ログには入力ファイル名・処理時間・採用アルゴリズム・閾値などを記録し、デバッグ可能性を高める。

## 5. モジュール設計要件
- `vocal_insight/pitch/` 配下に音程判定機能を集約するモジュール構造を新設。
  - `analyzer.py`: 音程判定アルゴリズムのエントリーポイント。
  - `alignment.py`: TSM/DTW など音程比較の補助ロジック。
  - `metrics.py`: ピッチ偏差や一致率などの指標計算。
  - `schemas.py`: JSON入出力用のデータクラス/TypedDict。
- 抽象プロトコル（例: `PitchComparatorProtocol`）を定義し、将来的なアルゴリズム差し替えを容易にする。
- `AnalysisConfig` に音程判定の有効/無効、使用アルゴリズム、プロンプト出力切替、閾値設定、結果保存先などの設定を追加する。
- 音程判定モジュールは既存特徴量抽出パイプラインと同様のインターフェース（`analyze(audio, reference, config)` など）を持ち、依存関係を最小限にする。

## 6. データ構造・JSON 設計
- 音程判定結果は以下のようなトップレベル構造を想定する。

```json
{
  "version": "1.0",
  "reference_audio": {
    "id": "ref_song_001",
    "source_path": "/path/to/reference.wav",
    "alignment": {
      "offset_seconds": 0.42,
      "DTW_cost": 12.5
    }
  },
  "pitch_accuracy": {
    "mean_cent_deviation": 23.4,
    "hit_rate": 0.78,
    "stability": 0.65,
    "per_section": [
      {
        "section_id": "verse_1",
        "cent_deviation": 18.2,
        "hit_rate": 0.82
      }
    ]
  },
  "expression_comparison": {
    "vibrato": null,
    "dynamics": null,
    "notes": []
  }
}
```
- `expression_comparison` ブロックは将来的な歌唱表現対照分析のためのプレースホルダとして用意し、拡張可能な連想配列を許容する。
- JSON スキーマは `schemas.py` で管理し、バージョン番号を付与して後方互換性を担保する。

## 7. 設定・インターフェース要件
- CLI には `--reference-audio`, `--pitch-analysis-enabled`, `--pitch-results-path` などのオプションを追加し、結果の保存先を任意に指定可能とする。
- API/UI でも同等の設定が適用できるよう、共通の設定構造体とシリアライズ方法を設ける。
- リファレンス音声が存在しない場合は設定に従い音程判定結果を無効化し、分析プロンプトへの出力を抑止する。
- プロンプト生成モジュールは音程判定結果をテンプレート化されたセクションとして受け取り、設定に応じて挿入/除外する。

## 8. テスト要件
- 合成音声を用いたユニットテストでピッチ偏差・一致率の計算結果が期待値と一致することを検証する。
- リファレンス音声の有無を切り替えた統合テストで、プロンプト出力の差異とJSONの有無を確認する。
- CLI エンドツーエンドテストで `--pitch-analysis-enabled` 指定時の出力ファイル生成、無指定時のスキップ挙動を検証する。
- エラーケース（異なるサンプルレート、長さ不一致、ピッチ推定失敗、設定値不正）を pytest で再現し、適切な例外とメッセージを確認する。
- JSON スキーマバリデーションテストを追加し、バージョンアップ時の後方互換性を確認する。

## 9. 運用・拡張要件
- アルゴリズムはオープンソース実装（例: `crepe`, `parselmouth`, `librosa`）を組み合わせ、追加コストなく導入する。
- 将来的にGPUを使用する高精度モードや外部API連携を追加できるよう、設定にアルゴリズム種別を持たせる。
- 音程判定結果の保存先や共有ディレクトリの指定をサポートし、他のシステムから参照可能にする。
- ログやメタデータは `output/pitch/` 等ユーザー設定のディレクトリに格納し、再解析を回避できるようキャッシュ機構を設ける。

## 10. リスク・課題
- ピッチ推定アルゴリズムの精度差により、ユーザー体験が変動する可能性がある。
- リファレンス音声のタイミング揃えが不十分だと、音程判定結果が悪化するため、整合性チェックが必要。
- JSON スキーマ拡張時の後方互換性維持が複雑化する可能性がある。

## 11. 用語
- **音程精度**: ユーザー歌唱のピッチがリファレンスの音程と一致している度合い。
- **リファレンス音声**: 比較対象となる理想的または模範的な歌唱音声。
- **DTW (Dynamic Time Warping)**: 時間軸が異なる2系列を比較するための距離計算手法。
