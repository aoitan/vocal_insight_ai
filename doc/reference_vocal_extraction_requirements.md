# リファレンスボーカル抽出機能 要件定義書

## 1. 背景と目的
- 音程判定機能に必要なリファレンスボーカルを生成するため、既存の音響分析パイプラインにボーカル抽出処理を組み込む。
- コアライブラリ、CLI、API、UI など複数クライアントから再利用可能なモジュールとして提供し、将来の機能拡張（モデル差し替え・外部API連携）に備える。
- 低コストかつローカル環境で完結する初期構成を実現し、必要に応じて高精度なモデルや外部リソースを選択できる柔軟性を確保する。

## 2. 対象範囲
- リファレンス音源（WAV）からボーカルのみを抽出するコア機能
- 抽出したボーカルを音程判定パイプラインへ連携するための設定とインターフェース
- CLI/API/UI からの操作およびファイル出力・参照先管理
- モデルファイル・抽出結果の保存先指定と共有リポジトリとの連携

## 3. 機能要件
- WAV入力のリファレンス音源からボーカル信号を抽出し、`numpy.ndarray` とサンプリングレートを返す。
- 抽出結果をオプションでファイル出力し、保存先パスを任意（絶対・相対、環境変数展開対応）に指定できるようにする。
- マルチチャネル音源のモノラル化、サンプリングレート統一、無音区間トリミングを自動処理する。
- `AnalysisConfig` にリファレンスボーカルの抽出設定（有効/無効、モデル種別、保存先パス、モデルパス、キャッシュパス等）を追加し、音程判定パイプラインが設定を通じて抽出結果を参照できるようにする。
- 既存の分析フローに `--reference-audio` などのCLI/API/UIフラグを追加し、リファレンス音源の読み込み・抽出・分析を一括実行可能にする。
- 抽出済みボーカルファイルの外部パスおよびモデルファイルの格納パスを指定でき、他リポジトリや他システムからの共有参照を可能にする。
- 抽出済みファイルが存在する場合は再抽出をスキップし、キャッシュを再利用する。

## 4. 非機能要件
- 5分の音源をCPU単体で5分以内に処理できる軽量モデルをデフォルト採用する。
- メモリ使用量は2GB以内を目安とし、大きな音源はチャンク処理で対応する。
- オフライン環境でも動作可能とし、外部クラウドAPIに依存しない構成を標準とする。
- 抽出時の品質指標（SNR、ピッチトラッカビリティなど）を計算し、ログまたはメタデータとして記録する。
- モデルロードは遅延・キャッシュ対応とし、リモートマウントパス指定時もタイムアウトやリトライを備える。

## 5. モジュール設計要件
- `vocal_insight/vocals/` を新設し、以下の構造でモジュール化する。
  - `extractor.py`: 抽出器のエントリーポイントとビジネスロジック
  - `loader.py`: オーディオ読み込み、前処理、モデルロード
  - `postprocess.py`: 後処理、トリミング、品質評価
  - `protocols.py`（任意）: 抽出器のインターフェース定義
- 抽出器の基底プロトコルを定義し、Demucs/Spleeter/外部API実装を差し替え可能にする。
- `AnalysisConfig` と関連設定クラスに抽出設定を組み込み、CLI/API/UI から同一の設定を利用できるようにする。
- 抽出結果とメタデータを構造体もしくは `dataclass` で表現し、他モジュールへ渡すインターフェースを統一する。
- キャッシュファイルの命名規則・配置を統一し、再利用判定を簡潔にする。

## 6. 設定・パス管理
- 抽出結果保存先、モデル格納先、キャッシュディレクトリをそれぞれ設定項目として提供。
- 設定は絶対パス・相対パスに対応し、`$HOME` などの環境変数を展開できるようにする。
- 複数のクライアントから同一設定を読み込めるよう、設定ファイル（例: `config.toml`）やCLI引数を通じて指定可能にする。
- 他リポジトリや外部システムと共有する場合、共有ディレクトリ（例: NAS、クラウド同期フォルダ）パスを直接指し示せるようにする。

## 7. テスト要件
- 疑似音源を用いたユニットテストで抽出信号のSTFTパワー比や基本周波数一致率を検証する。
- CLIエンドツーエンドテストで `--reference-audio` と `--reference-output-dir` 指定時に外部パスへ抽出ファイルが生成されることを確認する。
- エラーケース（非対応フォーマット、過大ファイル、抽出失敗、書き込み不可・読み込み不可パス）をpytestで再現し、例外メッセージと終了コードを検証する。
- 設定スナップショットテストを追加し、モデル差し替え・パス指定の有無に伴う設定値の変化を回帰確認する。

## 8. 運用・コスト要件
- デフォルトモデルはOSSライセンスで追加費用ゼロのものを採用し、オプションで高精度モデルや外部APIを選択可能にする。
- モデルダウンロードサイズは100MB以下を目標とし、初回起動時のみユーザー確認付きで取得できるようにする。取得先パスは設定で指定可能とする。
- 抽出結果とメタデータ（モデル名、推論時間、品質指標、出力パス）をユーザー指定ディレクトリ（例: `output/reference/`）に保存し、再計算を回避する。
- READMEやCLIヘルプにリファレンスボーカル抽出の手順、CPU/GPU要件、推定時間、推奨パス設定のベストプラクティスを追記する。

## 9. リスク・課題
- 軽量モデルの品質が不足する場合、追加コスト・時間を伴う高精度モデルの導入が必要になる可能性がある。
- 共有ストレージ使用時のI/O遅延やアクセス権の違いが処理失敗要因となる可能性がある。
- ボーカル抽出品質評価の指標・閾値は暫定的であり、実運用でのチューニングが前提となる。

## 10. 用語
- **リファレンス音源**: 音程判定の基準となる入力の歌唱音声ファイル。
- **ボーカル抽出**: ミックス音源からボーカル成分のみを分離する処理。
- **分析パイプライン**: セグメント検出、特徴量抽出、LLMプロンプト生成を行う既存の処理フロー。
